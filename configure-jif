#!/bin/sh

install=$1

exists() {
    if [ ! "$1" "$2" ]; then
	echo "** Error: $2 not found"
	exit 1
    fi
}

#creating bin/localusers

echo creating ${BIN}/localusers

cat > ${BIN}/localusers <<EOF
#!/bin/sh
# DO NOT EDIT - This file was automatically generated by configure.

JAVA='${JAVA}'
TOP="${TOP}"

if [ \$# -ne 1 ]
then 
	echo usage: \$0 principal-dir
	exit 1
fi

if [ ! -d \$1 ] 
then
	echo Error: \$1 is not a valid directory.
	exit 1
fi

${LIBPATH}=\$TOP${FILE_SEP}lib${PATH_SEP}\$${LIBPATH}
export ${LIBPATH}

"\$JAVA" ${JLC_CP} -Dprincipal.path=\$1 jif.policy.Passwd 
EOF
exists -f ${BIN}/localusers
chmod a+x ${BIN}/localusers

#creating bin/jif (the running script)
echo creating ${BIN}/jif
cat > ${BIN}/jif <<EOF
#!/bin/sh
# DO NOT EDIT - This file was automatically generated by configure.

JAVA='${JAVA}'
TOP="${TOP}"
PRINCIPAL_PATH="${PRINCIPAL_PATH}"

args=""
JIFCP="${JLC_CP}${PATH_SEP}\${PRINCIPAL_PATH}"
DEFCP=false
for arg in "\$@"; do
    if [ \${arg} = "-classpath" ]; then
    	DEFCP=true
    else 
    	if [ \${DEFCP} = "true" ]; then
	    JIFCP=\${JIFCP}${PATH_SEP}\${arg}
	    DEFCP=done
	else
	    args="\${args} \${arg}"
	fi
    fi	
done

if [ \${DEFCP} = "false" ]; then
    JIFCP=\${JIFCP}${PATH_SEP}\${CLASSPATH}
fi

${LIBPATH}=\$TOP${FILE_SEP}lib${PATH_SEP}\$${LIBPATH}
export ${LIBPATH}

"\${JAVA}" \${JIFCP} \${args}

EOF
exists -f ${BIN}/jif
chmod a+x ${BIN}/jif

if [ $install = install ]
then
    PRINCIPAL_PATH="${TOP}${FILE_SEP}users"

    mkdir -p ${PRINCIPAL_PATH}

    #creating bin/sampleusers
    echo creating ${BIN}/sampleusers

    cat > ${BIN}/sampleusers <<EOF
#!/bin/sh
# DO NOT EDIT - This file was automatically generated by configure.

JAVAC='${JAVAC}'
TOP="${TOP}"

"\$JAVAC" ${JLC_CP} -d \$1 \${TOP}${FILE_SEP}demo${FILE_SEP}jif${FILE_SEP}principal${FILE_SEP}*.java
EOF

    exists -f ${BIN}/sampleusers
    chmod a+x ${BIN}/sampleusers

    #create principals
    ${TOP}/bin/localusers ${PRINCIPAL_PATH}
    ${TOP}/bin/sampleusers ${PRINCIPAL_PATH}
fi
